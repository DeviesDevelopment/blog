<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>We Got Cached üò± | Devies blog</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="A Tip for Troubleshooting Docker Build Problems in Azure"><meta name=generator content="Hugo 0.107.0"><meta name=robots content="index, follow"><link rel=stylesheet href=/blog/ananke/css/main.min.49b20d3cec9ed5416b049a3758cf8a4707639bd0d32cee144918c11a5bbaddd2.css><link rel="shortcut icon" href=/blog/favicon.ico type=image/x-icon><meta property="og:title" content="We Got Cached üò±"><meta property="og:description" content="A Tip for Troubleshooting Docker Build Problems in Azure"><meta property="og:type" content="article"><meta property="og:url" content="https://deviesdevelopment.github.io/blog/posts/we-got-cached/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-13T13:29:31+02:00"><meta property="article:modified_time" content="2022-05-13T13:29:31+02:00"><meta itemprop=name content="We Got Cached üò±"><meta itemprop=description content="A Tip for Troubleshooting Docker Build Problems in Azure"><meta itemprop=datePublished content="2022-05-13T13:29:31+02:00"><meta itemprop=dateModified content="2022-05-13T13:29:31+02:00"><meta itemprop=wordCount content="535"><meta itemprop=keywords content="docker,azure,build,ci,cd,pipeline,firefox,"><meta name=twitter:card content="summary"><meta name=twitter:title content="We Got Cached üò±"><meta name=twitter:description content="A Tip for Troubleshooting Docker Build Problems in Azure"><script async src="https://www.googletagmanager.com/gtag/js?id=G-72VEGX2X3B"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-72VEGX2X3B",{anonymize_ip:!1})}</script></head><body class="ma0 avenir bg-near-white production"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/blog/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/blog/logo.png class="w100 mw5-ns" alt="Devies blog"></a><div class="flex-l items-center"><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">We Got Cached üò±</h1><p class=tracked>By <strong>Sarosh Nasir, √ñmer Simsek</strong></p><time class="f6 mv4 dib tracked" datetime=2022-05-13T13:29:31+02:00>May 13, 2022</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>For the past couple of weeks, we&rsquo;ve been working on a React app from scratch. Additionally, we&rsquo;ve added pipelines in Azure as an attempt to achieve <span style=font-family:Arial;color:#00c0ff>MAXIMUM EFFICIENCY</span> when it comes to deployment and integration. So there we are. It&rsquo;s a lovely morning. The sun is shining, the coffee is warm, and we&rsquo;re ready to drop some lines of code! üòé</p><p>Last week we built and deployed a version of our React app that had a slightly faulty CSS attribute that made the header of the app take up the whole screen. Thus our first and foremost task was to fix it so that it only takes up a small area at the top of the screen. We used the Inspection feature in Firefox Developer Edition to pinpoint the faulty CSS and determine the issue, which we managed to do. The next step was to apply that fix in our code to see what would happen. The fix worked locally by running the React app using <code>yarn start</code> as well as deploying a Docker image. Great, the fix is ready to be deployed using our Azure pipelines!</p><p>Except there was no change. Any fix we attempted to do worked locally but never appeared in the dev environment. We asked our colleagues and no one could pinpoint why this was happening. Alas, we went back to basics and changed the header text. If not CSS, a text change should definitely be shown, right? <span style=font-family:Arial;font-weight:700;color:#f20>WRONG!</span>üôÖ‚Äç‚ôÇÔ∏è</p><p>We were totally confounded of why this was happening. Maybe it wasn&rsquo;t our code that was the problem, perhaps the issue lies with Docker and how the Docker image is being built. Lo and behold, we see the following piece of code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Step x/z : COPY . /app
</span></span><span style=display:flex><span>---&gt; 123abc456
</span></span><span style=display:flex><span>Step y/z : RUN yarn build
</span></span><span style=display:flex><span>---&gt; Using cache
</span></span><span style=display:flex><span>---&gt; abc123def
</span></span></code></pre></div><p><code>Using cache</code>? We know that Docker <a href=https://docs.semaphoreci.com/ci-cd-environment/docker-layer-caching/>uses cache for efficiency</a>, and only uses cache when there&rsquo;s no change in the Docker Layers. However, we have clearly made changes to our code, so why aren&rsquo;t those changes not being shown? Upon further reading, we realized something. When <code>RUN yarn build</code> is being run, the files are being updated in the container itself, which apparently doesn&rsquo;t trigger a cache check. <span style=font-family:Arial;font-weight:700;color:#f90>OMG, WE&rsquo;VE BEEN CACHED!</span>üò±</p><p>Luckily, we can pass Docker arguments to our Docker task in our <code>azure-pipelines.yaml</code> to not include cache:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>task</span>: <span style=color:#ae81ff>Docker@2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containerRegistry</span>: <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Dockerfile</span>: <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>arguments</span>: --<span style=color:#66d9ef>no</span>-<span style=color:#ae81ff>cache</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Build&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>task</span>: <span style=color:#ae81ff>Docker@2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>inputs</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containerRegistry</span>: <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>repository</span>: <span style=color:#ae81ff>...</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: <span style=color:#ae81ff>push</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>displayName</span>: <span style=color:#e6db74>&#34;Push&#34;</span>
</span></span></code></pre></div><p>Notice that we don&rsquo;t use the existing Docker pipeline command <code>buildAndPush</code>. This is according to Azure documentation which states that arguments are ignored when using the <code>buildAndPush</code> command:</p><blockquote><p>The arguments input is evaluated for all commands except <code>buildAndPush</code>. As <code>buildAndPush</code> is a convenience command (<code>build</code> followed by <code>push</code>), arguments input is ignored for this command.</p></blockquote><p>Now it works! üöÄ üôå</p><h2 id=key-learnings>Key learnings:</h2><ul><li>Docker won&rsquo;t cache check when <code>RUN</code> command is being run, for example <code>RUN yarn build</code> or even <code>RUN apt-get -y update</code>.</li><li>When you&rsquo;re stuck, consider going back to basics and making minimal obvious changes to your code to make sure that your changes are being applied!</li><li>Consult your closest documentation when stuck!</li></ul><ul class=pa0><li class="list di"><a href=/blog/tags/docker/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Docker</a></li><li class="list di"><a href=/blog/tags/azure/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Azure</a></li><li class="list di"><a href=/blog/tags/build/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">build</a></li><li class="list di"><a href=/blog/tags/ci/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">CI</a></li><li class="list di"><a href=/blog/tags/cd/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">CD</a></li><li class="list di"><a href=/blog/tags/pipeline/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">pipeline</a></li><li class="list di"><a href=/blog/tags/firefox/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">firefox</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://deviesdevelopment.github.io/blog/>&copy; Devies blog 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>