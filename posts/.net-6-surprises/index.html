<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>.NET 6 Surprises | Devies blog</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="A few weeks ago, we upgraded one of our projects from .NET 5 to .NET 6, since .NET 5 was nearing end of support. In this process, we ran into a few hurdles. This post will go through a few of them that were a bit unexpected, and why we ran into them.
AccessTokenValidation deprecated This isn&rsquo;t completely related to .NET 6 in itself, but we ran into the issue during the upgrade."><meta name=generator content="Hugo 0.104.3"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/blog/ananke/css/main.min.9036e8ca4a3287e27ab2eb511a473b75bdc83acf6db11ab67b1704e7b4fdd475.css><link rel="shortcut icon" href=/blog/favicon.ico type=image/x-icon><meta property="og:title" content=".NET 6 Surprises"><meta property="og:description" content="A few weeks ago, we upgraded one of our projects from .NET 5 to .NET 6, since .NET 5 was nearing end of support. In this process, we ran into a few hurdles. This post will go through a few of them that were a bit unexpected, and why we ran into them.
AccessTokenValidation deprecated This isn&rsquo;t completely related to .NET 6 in itself, but we ran into the issue during the upgrade."><meta property="og:type" content="article"><meta property="og:url" content="https://deviesdevelopment.github.io/blog/posts/.net-6-surprises/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-06-15T09:15:58+02:00"><meta property="article:modified_time" content="2022-06-15T09:15:58+02:00"><meta itemprop=name content=".NET 6 Surprises"><meta itemprop=description content="A few weeks ago, we upgraded one of our projects from .NET 5 to .NET 6, since .NET 5 was nearing end of support. In this process, we ran into a few hurdles. This post will go through a few of them that were a bit unexpected, and why we ran into them.
AccessTokenValidation deprecated This isn&rsquo;t completely related to .NET 6 in itself, but we ran into the issue during the upgrade."><meta itemprop=datePublished content="2022-06-15T09:15:58+02:00"><meta itemprop=dateModified content="2022-06-15T09:15:58+02:00"><meta itemprop=wordCount content="472"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content=".NET 6 Surprises"><meta name=twitter:description content="A few weeks ago, we upgraded one of our projects from .NET 5 to .NET 6, since .NET 5 was nearing end of support. In this process, we ran into a few hurdles. This post will go through a few of them that were a bit unexpected, and why we ran into them.
AccessTokenValidation deprecated This isn&rsquo;t completely related to .NET 6 in itself, but we ran into the issue during the upgrade."><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-72VEGX2X3B","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="ma0 avenir bg-near-white production"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/blog/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/blog/logo.png class="w100 mw5-ns" alt="Devies blog"></a><div class="flex-l items-center"><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">.NET 6 Surprises</h1><p class=tracked>By <strong>Fredrik Sjöholm</strong></p><time class="f6 mv4 dib tracked" datetime=2022-06-15T09:15:58+02:00>June 15, 2022</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>A few weeks ago, we upgraded one of our projects from .NET 5 to .NET 6, since .NET 5 was nearing end of support. In this process, we ran into a few hurdles. This post will go through a few of them that were a bit unexpected, and why we ran into them.</p><h2 id=accesstokenvalidation-deprecated>AccessTokenValidation deprecated</h2><p>This isn&rsquo;t completely related to .NET 6 in itself, but we ran into the issue during the upgrade. While upgrading our Nuget dependencies, we had some trouble with mismatching version numbers on transient dependencies. While we tried to upgrade the <code>IdentityModel</code> package to a newer version, <code>AccessTokenValidation</code> had a dependency to an older version. It turned out that <code>AccessTokenValidation</code> had been <a href=https://leastprivilege.com/2020/07/06/flexible-access-token-validation-in-asp-net-core/>deprecated</a> since we added it. This was solved by removing the dependency by simply substituting a call to <code>AddIdentityServerAuthentication</code> with a call to <code>AddJwtBearer</code>. We don’t use Introspection to validate tokens in our solution, but it is possible to combine JwtBearer and Introspection using the <code>ForwardDefaultSelection</code> option.</p><h2 id=datetime-handling-in-npgsql-6>DateTime handling in Npgsql 6</h2><p>Once all dependencies were handled and the application could run properly, we ran into another problem. We got an exception when trying to save some database entries. This was because of <a href=https://www.npgsql.org/doc/release-notes/6.0.html#major-changes-to-timestamp-mapping>a breaking change</a> in Npgsql: <code>DateTime</code> objects with <code>Kind=Local</code> or <code>Unknown</code> are no longer supported. In one of our applications, we create all objects ourselves, so it was no big deal to change them to conform with the new behavior.</p><p>In another of our applications, we save objects which are generated by an external library. In this case, the easiest solution was to set the <code>Npgsql.EnableLegacyTimestampBehavior</code> flag rather than converting the timestamps.</p><h2 id=ssl-modes-in-npgsql-6>SSL Modes in Npgsql 6</h2><p>A third issue appeared when we deployed our application to our dev environment and it crashed on startup. This was due to <a href=https://www.npgsql.org/doc/release-notes/6.0.html#changes-to-ssl-configuration-ssl-moderequire>another breaking change</a> in Npgsql: it no longer supports <code>SSL Mode=Require</code> without also adding <code>Trust Server Certificate=true</code>. In our case, we want to validate our certificates, so we set <code>SSL Mode=VerifyFull</code>.</p><h2 id=what-weve-learned>What we&rsquo;ve learned</h2><p>One of these issues was disovered while testing the application manually and another when the application was deployed to our dev environment. Neither is of course ideal - we want to catch these issue much earlier. While the breaking changes in Npgsql were well documented, it can be difficult to keep track of whether or not a particular breaking change will affect a system, and how.</p><p>This project is still in a very early stage. We don&rsquo;t have and production users and business demands are not fully specified yet. While we have decent unit test coverage and a few e2e tests, we&rsquo;re still in the process of setting up a proper test suite. For example, we recently added some <a href=https://deviesdevelopment.github.io/blog/posts/why-you-should-add-a-cypress-test-to-your-ci-cd-pipeline/>Cypress</a> tests. There will be more posts in the future about how we work with testing and deployment, so stay tuned!</p><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://deviesdevelopment.github.io/blog>&copy; Devies blog 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>