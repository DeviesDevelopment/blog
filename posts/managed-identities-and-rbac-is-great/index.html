<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Using managed identities and role based access control is great! |</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="In a project I work with we use Azure App Service for hosting an ASP.NET application. All external configuration used by the application is stored in an Azure App Configuration store. I recently updated how the application authenticates toward the App Configuration store and think it worked out pretty well.
Prior to the change we used connection strings (i.e. a string containing endpoint, username and password) for authentication. The main drawback with this is that we have to manage the credentials ourselves."><meta name=generator content="Hugo 0.96.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/blog/ananke/css/main.min.ceb444b34b6d1508dbe3ab8cbf937a305a3f952886a8f52fbbb14068f75e1a94.css><link rel="shortcut icon" href=/blog/favicon.ico type=image/x-icon><meta property="og:title" content="Using managed identities and role based access control is great!"><meta property="og:description" content="In a project I work with we use Azure App Service for hosting an ASP.NET application. All external configuration used by the application is stored in an Azure App Configuration store. I recently updated how the application authenticates toward the App Configuration store and think it worked out pretty well.
Prior to the change we used connection strings (i.e. a string containing endpoint, username and password) for authentication. The main drawback with this is that we have to manage the credentials ourselves."><meta property="og:type" content="article"><meta property="og:url" content="https://deviesdevelopment.github.io/blog/posts/managed-identities-and-rbac-is-great/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-15T20:15:15+01:00"><meta property="article:modified_time" content="2022-03-15T20:15:15+01:00"><meta itemprop=name content="Using managed identities and role based access control is great!"><meta itemprop=description content="In a project I work with we use Azure App Service for hosting an ASP.NET application. All external configuration used by the application is stored in an Azure App Configuration store. I recently updated how the application authenticates toward the App Configuration store and think it worked out pretty well.
Prior to the change we used connection strings (i.e. a string containing endpoint, username and password) for authentication. The main drawback with this is that we have to manage the credentials ourselves."><meta itemprop=datePublished content="2022-03-15T20:15:15+01:00"><meta itemprop=dateModified content="2022-03-15T20:15:15+01:00"><meta itemprop=wordCount content="557"><meta itemprop=keywords content="Azure,RBAC,Azure AD,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using managed identities and role based access control is great!"><meta name=twitter:description content="In a project I work with we use Azure App Service for hosting an ASP.NET application. All external configuration used by the application is stored in an Azure App Configuration store. I recently updated how the application authenticates toward the App Configuration store and think it worked out pretty well.
Prior to the change we used connection strings (i.e. a string containing endpoint, username and password) for authentication. The main drawback with this is that we have to manage the credentials ourselves."></head><body class="ma0 avenir bg-near-white production"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/blog/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/blog/logo.png class="w100 mw5-ns" alt></a><div class="flex-l items-center"><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Using managed identities and role based access control is great!</h1><p class=tracked>By <strong>Rickard Andersson</strong></p><time class="f6 mv4 dib tracked" datetime=2022-03-15T20:15:15+01:00>March 15, 2022</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>In a project I work with we use <a href=https://docs.microsoft.com/en-us/azure/app-service/overview>Azure App Service</a> for hosting an ASP.NET application. All external configuration used by the application is stored in an <a href=https://docs.microsoft.com/en-us/azure/azure-app-configuration/overview>Azure App Configuration</a> store. I recently updated how the application authenticates toward the App Configuration store and think it worked out pretty well.</p><p>Prior to the change we used connection strings (i.e. a string containing endpoint, username and password) for authentication. The main drawback with this is that we have to manage the credentials ourselves. We must provide the connection string to the application in some way (e.g. set it in a CI/CD pipeline after deploying our application). If our connection string is compromised, we must regenerate it and make sure that the application is provided with the new one.</p><p>Additionally, when running our application locally the connection string must be accessible. It&rsquo;d be super bad to store the connection string in source control, so each developer need to obtain the connection string and store it locally in some way, e.g. with <a href="https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?view=aspnetcore-6.0&tabs=linux">dotnet user-secrets</a>).</p><hr><p>Instead of connection strings, we now use a <a href=https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview>managed identity</a> together with role-based access control (RBAC). This means that the App Service has an identity in Azure Active Directory, completely managed by Azure. We don&rsquo;t need to care about any credentials, the authentication just works. To manage what services/resources the managed identity can access, we assign roles to the managed identity, with a proper scope.</p><p>If you&rsquo;re using terraform, the relevant changes you need to make will look something like below.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_app_service&#34; &#34;example&#34;</span> {
</span></span><span style=display:flex><span>  name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my-app-service&#34;</span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>identity</span> {
</span></span><span style=display:flex><span>    type <span style=color:#f92672>=</span> <span style=color:#66d9ef>SystemAssigned</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_app_configuration&#34; &#34;example&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my-app-config&#34;</span>
</span></span><span style=display:flex><span>  ...
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_role_assignment&#34; &#34;example&#34;</span> {
</span></span><span style=display:flex><span>  scope                <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_app_configuration</span>.<span style=color:#66d9ef>example</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  role_definition_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;App Configuration Data Reader&#34;</span>
</span></span><span style=display:flex><span>  principal_id         <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_app_service</span>.<span style=color:#66d9ef>example</span>.<span style=color:#66d9ef>identity</span>[<span style=color:#ae81ff>0</span>].<span style=color:#66d9ef>principal_id</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>By adding a <code>identity</code> block of type <code>SystemAssigned</code> a managed identity will be generated for the App Service. The principal_id of the managed identity is exposed in the <code>.identity[0].principal_id</code> attribute of the App Service. We must use this id to assign roles to the newly created managed identity (see the <code>azurerm_role_assignment</code> resource).</p><hr><p>What about running our application locally? As I mentioned above, with connection strings you must make sure you have the connection string available locally in some way. Turns out this is way simpler when using RBAC. The key to it all is the <code>DefaultAzureCredential</code> class provided by the <a href=https://www.nuget.org/packages/Azure.Identity/>Azure.Identity</a> library.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span>builder.Host.ConfigureAppConfiguration(builder =&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    builder.AddAzureAppConfiguration(options =&gt;
</span></span><span style=display:flex><span>        options.Connect(<span style=color:#66d9ef>new</span> Uri(<span style=color:#e6db74>&#34;APP-CONFIG-URL&#34;</span>), <span style=color:#66d9ef>new</span> DefaultAzureCredential()));
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>By using <code>DefaultAzureCredential</code>, our code will attempt to use several different credential providers. So, while the application is running in Azure App Service, it&rsquo;ll use the <code>ManagedIdentityCredential</code>, while it can fall back to something like <code>AzureCliCredential</code> or <code>VisualStudioCodeCredential</code> while we run the application locally. All we need to do to make this work is to ensure that all personal developer accounts has the proper Azure AD roles (e.g. <code>App Configuration Data Reader</code>).</p><hr><p>With managed identities and RBAC we rid ourselves of the need to manage credentials. It&rsquo;s more secure to let Azure handle concerns like this for us. Additionally, we gain a better developer experience by removing manual steps needed to have the developer environment up and running.</p><p>Note that managed identities and RBAC is in no way limited to Azure App Config. You can use this authentication/authorization mechanism for a lot of Azure resources. It&rsquo;s still in preview for some though.</p><ul class=pa0><li class=list><a href=/blog/tags/azure class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Azure</a></li><li class=list><a href=/blog/tags/rbac class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">RBAC</a></li><li class=list><a href=/blog/tags/azure-ad class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Azure AD</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://deviesdevelopment.github.io/blog>&copy;</a><div><div class=ananke-socials></div></div></div></footer></body></html>