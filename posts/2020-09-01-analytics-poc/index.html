<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Analytics without third-party tools |</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Finding out how much traffic your site has and how your users interact with it is always crucial. Such information will enable you to scale your backend properly, fine-tune the user experience and weed out unused features. Some even go so far as claiming that data is the &ldquo;gold of our time&rdquo;. Regardless of the truth of that claim, few can dispute the usefulness of user analytics data.
The go-to solution for most developers is to use Google Analytics (in fact used by 55% of all websites) or some other third party framework."><meta name=generator content="Hugo 0.98.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel=stylesheet href=/blog/ananke/css/main.min.ceb444b34b6d1508dbe3ab8cbf937a305a3f952886a8f52fbbb14068f75e1a94.css><link rel="shortcut icon" href=/blog/favicon.ico type=image/x-icon><meta property="og:title" content="Analytics without third-party tools"><meta property="og:description" content="Finding out how much traffic your site has and how your users interact with it is always crucial. Such information will enable you to scale your backend properly, fine-tune the user experience and weed out unused features. Some even go so far as claiming that data is the &ldquo;gold of our time&rdquo;. Regardless of the truth of that claim, few can dispute the usefulness of user analytics data.
The go-to solution for most developers is to use Google Analytics (in fact used by 55% of all websites) or some other third party framework."><meta property="og:type" content="article"><meta property="og:url" content="https://deviesdevelopment.github.io/blog/posts/2020-09-01-analytics-poc/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-01T00:00:00+00:00"><meta property="article:modified_time" content="2020-09-01T00:00:00+00:00"><meta itemprop=name content="Analytics without third-party tools"><meta itemprop=description content="Finding out how much traffic your site has and how your users interact with it is always crucial. Such information will enable you to scale your backend properly, fine-tune the user experience and weed out unused features. Some even go so far as claiming that data is the &ldquo;gold of our time&rdquo;. Regardless of the truth of that claim, few can dispute the usefulness of user analytics data.
The go-to solution for most developers is to use Google Analytics (in fact used by 55% of all websites) or some other third party framework."><meta itemprop=datePublished content="2020-09-01T00:00:00+00:00"><meta itemprop=dateModified content="2020-09-01T00:00:00+00:00"><meta itemprop=wordCount content="1037"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Analytics without third-party tools"><meta name=twitter:description content="Finding out how much traffic your site has and how your users interact with it is always crucial. Such information will enable you to scale your backend properly, fine-tune the user experience and weed out unused features. Some even go so far as claiming that data is the &ldquo;gold of our time&rdquo;. Regardless of the truth of that claim, few can dispute the usefulness of user analytics data.
The go-to solution for most developers is to use Google Analytics (in fact used by 55% of all websites) or some other third party framework."></head><body class="ma0 avenir bg-near-white production"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/blog/ class="f3 fw2 hover-white no-underline white-90 dib"><img src=/blog/logo.png class="w100 mw5-ns" alt></a><div class="flex-l items-center"><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Analytics without third-party tools</h1><p class=tracked>By <strong>Gustav Sundin, Rickard Andersson</strong></p><time class="f6 mv4 dib tracked" datetime=2020-09-01T00:00:00Z>September 1, 2020</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><p>Finding out how much traffic your site has and how your users interact with it is always crucial. Such information will enable you to scale your backend properly, fine-tune the user experience and weed out unused features. Some even go so far as claiming that data is the &ldquo;gold of our time&rdquo;. Regardless of the truth of that claim, few can dispute the usefulness of user analytics data.</p><p>The go-to solution for most developers is to use Google Analytics (in fact used by <a href=https://w3techs.com/technologies/details/ta-googleanalytics>55% of all websites</a>) or some other third party framework. Although this can surely be a valid choice and a quick way forward, using a third party tool to handle user analytics data raises some concerns. First of all, you give away data about how your product is being used for free (or perhaps you even pay for it!). And more importantly, it makes it harder for you to guarantee that potentially sensitive user data is handled in an anonymous and secure way. The best way to guarantee that your data is in safe hands is to let as few hands as possible get in touch with the data.</p><p>For the above reasons, you should at least consider implementing your own analytics tool. It turns out that it is actually much simpler than it sounds, at least as long as your use case is relatively simple (which it most probably is).</p><h2 id=implementation>Implementation</h2><p>As a proof of concept, we implemented a quick demonstration in React. The React application that we made will gather analytics data about the very same website that is used to display the gathered data. Disclaimer: the solution we came up with is heavily inspired by <a href=https://www.pcmaffey.com/roll-your-own-analytics/>a great blog post by P.C. Maffey</a>.</p><p>Live demo: <a href=http://devies-analytics-poc.s3-website-eu-west-1.amazonaws.com/>http://devies-analytics-poc.s3-website-eu-west-1.amazonaws.com/</a></p><p>Source code: <a href=https://github.com/DeviesDevelopment/analytics-poc>https://github.com/DeviesDevelopment/analytics-poc</a></p><h3 id=overview>Overview</h3><p>The data we are interested in is to count the number of <strong>sessions</strong> on our website. For each session we are also interested in knowing which pages were visited, in which order and how long the user stayed on each page. A session therefore consists of a number of <strong>events</strong>, where every page change is considered a new event. We decided to only store non-sensitive user data, meaning no IP addresses or other data that can be used to identify the user behind a specific session. We also decided not to use any cookies in the user&rsquo;s browser to detect whether it&rsquo;s a new or returning visitor.</p><h3 id=how-it-works>How it works</h3><p>Every time the path changes, an event is stored in the <a href=https://github.com/DeviesDevelopment/analytics-poc/blob/master/frontend/src/Analytics.jsx>Analytics.jsx</a> component. When the browser session ends, all the collected events are sent (together with some metadata) in a single request to a lambda endpoint. The lambda then parses the data and saves it to a DynamoDB table. This means that for every user session, only a single request is sent to the analytics endpoint, making this approach very lightweight.</p><h3 id=detecting-path-changes>Detecting path changes</h3><p>To detect when the path changes, we have added a component (<a href=https://github.com/DeviesDevelopment/analytics-poc/blob/master/frontend/src/Analytics.jsx>Analytics.jsx</a>) to track it on the top-level in our DOM. The component doesn&rsquo;t render anything, but leverages the following React hook to detect path changes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=display:flex><span><span style=color:#a6e22e>React</span>.<span style=color:#a6e22e>useEffect</span>(() =&gt; {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pushEvent</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pathname</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>pathname</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> Date.<span style=color:#a6e22e>now</span>(),
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#34;Location changed&#34;</span>, <span style=color:#a6e22e>location</span>.<span style=color:#a6e22e>pathname</span>);
</span></span><span style=display:flex><span>}, [<span style=color:#a6e22e>location</span>]);
</span></span></code></pre></div><p>The events are best stored as a simple array in the state of the component. You can also use Redux if you prefer, or store it using a <a href=https://reactjs.org/docs/refs-and-the-dom.html>ref</a> in a stateless component.</p><h3 id=sending-data-to-the-backend>Sending data to the backend</h3><p>To detect when the browser session ends, we have set up various event listeners:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>window.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#34;pagehide&#34;</span>, <span style=color:#a6e22e>endSession</span>);
</span></span><span style=display:flex><span>window.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#34;beforeunload&#34;</span>, <span style=color:#a6e22e>endSession</span>);
</span></span><span style=display:flex><span>window.<span style=color:#a6e22e>addEventListener</span>(<span style=color:#e6db74>&#34;unload&#34;</span>, <span style=color:#a6e22e>endSession</span>);
</span></span></code></pre></div><p>The <code>endSession()</code> function in turn sends a <a href=https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon>beacon</a> with the collected data to the backend (a beacon is a request that is sent asynchronously and that will finish in the background even if the browser session is terminated).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>window.<span style=color:#a6e22e>navigator</span>.<span style=color:#a6e22e>sendBeacon</span>(<span style=color:#a6e22e>url</span>, <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>data</span>));
</span></span></code></pre></div><p>Some workarounds have had to be added to handle various browsers as well, see <a href=https://www.pcmaffey.com/roll-your-own-analytics/>the original post</a> for more details.</p><h3 id=backend>Backend</h3><p>Our backend is hosted on AWS and set up using CloudFormation and AWS SAM. It is very minimal, containing only an API Gateway as interface, a DynamoDB database for storing the gathered user analytics data and two lambda functions; one for saving data and one for retrieving data. You can browse the template file <a href=https://github.com/DeviesDevelopment/analytics-poc/blob/master/backend/template.yml>here</a>.</p><h2 id=next-steps>Next steps</h2><p>First of all, you should consider what it is that you really want to know about how people use your product. Just collecting data for the sake of it is pretty pointless. That being said, here are some ideas for how this POC could be expanded:</p><ul><li>Gather other types of events other than just path changes. Such as: buttons clicked, external link opened.</li><li>Improve UI for browsing data.</li><li>Aggregate other kinds of metrics. See <a href=https://en.wikipedia.org/wiki/Web_analytics#On-site_web_analytics_-_definitions>this list on Wikipedia</a> for some inspiration.</li><li>Different browsers sometimes behaves very differently, so more work is needed to make sure we handle all possible combinations of devices and browsers properly.</li><li>If you use some other implementation than React, this solution should be straightforward to reuse. Here is <a href=https://github.com/Sundin/armory-online/blob/master/src/components/Analytics.vue>an implementation in Vue</a>.</li><li>Implement some check to filter out bots and scrapers, as you are probably only interested in the behaviour of real human users.</li></ul><h2 id=takeaways>Takeaways</h2><p>User behaviour analytics can be collected anonymously without the need for any big tool or framework. The upside of this approach is that you don&rsquo;t need to bloat down your application with any heavy third-party dependencies, and also that you will maintain control of your users&rsquo; data. The only downside is of course that you need to implement the interface for aggregating and displaying the collected data yourself.</p><p>While this proof-of-concept shows that is relatively easy to set up your own analytics infrastructure, there are probably countless number of corner cases that we did not consider. In a real-life production application, the golden middle way would therefore probably be to choose a self-hosted, open-source analytics tool instead. That way you stay in control of the data, while still not having to fix all the bugs on your own. Some of the alternatives include <a href=http://www.openwebanalytics.com/>Open Web Analytics</a>, <a href=https://matomo.org/matomo-on-premise/>Matomo</a>, <a href=https://count.ly/community-edition>Countly</a> and <a href=https://plausible.io/self-hosted-web-analytics>Plausible</a>.</p><h2 id=references>References</h2><ul><li><p>The original idea and some of the implementation taken from <a href=https://www.pcmaffey.com/roll-your-own-analytics/>this blog post</a>.</p></li><li><p>The <a href=https://en.wikipedia.org/wiki/Web_analytics>Wikipedia article on web analytics</a> contains much background information about this topic.</p></li></ul><p>By Gustav Sundin & Rickard Andersson</p><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://deviesdevelopment.github.io/blog>&copy;</a><div><div class=ananke-socials></div></div></div></footer></body></html>